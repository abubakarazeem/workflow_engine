$(function(){
  /*
            ON LOAD SCRIPT
  */
  let notification_area = $('#js_ajax_request_notification');

  $('.js-list-group-item').click(function() {
    /*
      => Get currently clicked list item.
      => Get user id from the currently clicked list item.
      => Use this user id to fetch user data through ajax.
      => Display data on view.
    */
    let current_clicked_list_item = $(this);
    let current_clicked_user_id = current_clicked_list_item.attr('data-user-id');

    prepare_and_send_request_for_user_data(current_clicked_user_id);
  });

  $('#js_change_role_submit').click(function() {
    let current_user_id = $('#js_current_user_id').val();
    let new_role_id = $('#js_role_select').val();

    prepare_and_send_request_for_role_change(current_user_id, new_role_id);
  });

  /*
            HELPER FUNCTIONS
  */

  function perform_ajax(url, type, data, success_callback, failure_callback, before_send_callback = null, complete_callback = null ) {
    $.ajax({
      async: true,
      url: url,
      type: type,
      data: data,
      dataType: 'json',
      error: failure_callback,
      success: success_callback,
      beforeSend: before_send_callback,
      complete: complete_callback
    });
  }

  function prepare_and_send_request_for_user_data(user_id) {
    // PREPARE DATA
    let data = {
      user_id: user_id
    }

    // URL
    let url = "<%= users_privileges_edit_path %>";

    let success_callback = function(result, status, xhr) {
      // Set user id in hidden field.
      $('#js_current_user_id').val(result.data.user.id);

      // RENDER RESULTS
      let user_fullname = `${result.data.user.first_name} ${result.data.user.last_name}`;
      $('#js_user_fullname_heading').html(user_fullname);

      let role_option_selector_string = `#js_role_select option[value=${result.data.user.role_id}]`;

      // Mark it selected.
      $(role_option_selector_string).prop('selected', true);
    }

    let failure_callback = function(xhr, txt_status, error_thrown) {
      failure_msg = `Request for loading user role failed with status code of ${xhr.status} and message of ${error_thrown}`;
      notification_area.html(prepare_notification_html(failure_msg, 'danger'));
    }

    let before_send_callback = function() {
      // Empty user name heading
      $('#js_user_fullname_heading').html('');

      // Clear notification_area
      notification_area.html('');

      // Add loader class.
      notification_area.addClass('loader');
    }

    let complete_callback = function (xhr, txt_status) {
      notification_area.removeClass('loader');
    }

    perform_ajax(url, 'POST', data, success_callback, failure_callback, before_send_callback, complete_callback);
  }

  function prepare_and_send_request_for_role_change(user_id, role_id) {
    // PREPARE DATA
    let data = {
      user_id: user_id,
      role_id: role_id
    }

    // URL
    let url = "<%= users_privileges_edit_submit_path %>";

    let success_callback = function(result, status, xhr) {
      notification_area.html(prepare_notification_html(`Role changed successfully! Response: ${result.data.status}`, 'success'));

      // Change text for the list item too.
      $('.js-list-group-item.active .js-list-group-item-text').html(result.data.role_name);
    }

    let failure_callback = function(xhr, txt_status, error_thrown) {
      failure_msg = `Request for Member role failed with status code of ${xhr.status} and message of ${error_thrown}`;
      notification_area.html(prepare_notification_html(failure_msg, 'danger'));
    }

    let before_send_callback = function() {
      notification_area.addClass('loader');
    }

    let complete_callback = function (xhr, txt_status) {
      notification_area.removeClass('loader');
    }

    perform_ajax(url, 'POST', data, success_callback, failure_callback, before_send_callback, complete_callback);
  }

  function prepare_notification_html(msg, alert_class) {
    html = `<div class="alert alert-${alert_class}">
              <a href="#" class="close" data-dismiss="alert">&times;</a>
              ${msg}
            </div>`;
    return html;
  }
});